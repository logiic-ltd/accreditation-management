{% extends "templates/web.html" %}

{% block page_content %}
<div class="content-wrapper">
    <div class="container">
        <h1 class="mb-4">Self Assessment Form</h1>
        <form id="selfAssessmentForm">
            <div class="form-group">
                <label for="schoolName">School Name</label>
                <input type="text" class="form-control" id="schoolName" name="school_name" required>
            </div>
            <div class="form-group">
                <label for="submissionDate">Submission Date</label>
                <input type="date" class="form-control" id="submissionDate" name="submission_date" required>
            </div>
            <div id="indicators"></div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
</div>

<script>
frappe.ready(function() {
    // Load the indicator options from the JSON configuration file
    frappe.call({
        method: 'frappe.client.get',
        args: {
            doctype: 'File',
            name: 'accreditation_management/config/indicator_options.json'
        },
        callback: function(r) {
            if (r.message) {
                const indicators = JSON.parse(r.message.content);
                const indicatorsContainer = document.getElementById('indicators');
                for (const [area, criteria] of Object.entries(indicators)) {
                    const areaDiv = document.createElement('div');
                    areaDiv.innerHTML = `<h3>${area}</h3>`;
                    indicatorsContainer.appendChild(areaDiv);
                    for (const [criterion, indicatorData] of Object.entries(criteria)) {
                        const criterionDiv = document.createElement('div');
                        criterionDiv.innerHTML = `<h4>${criterion}</h4>`;
                        areaDiv.appendChild(criterionDiv);
                        for (const [indicatorKey, indicator] of Object.entries(indicatorData)) {
                            const formGroup = document.createElement('div');
                            formGroup.className = 'form-group';
                            formGroup.innerHTML = `
                                <label for="${indicatorKey}">${indicator.label}</label>
                                <select class="form-control" id="${indicatorKey}" name="${indicatorKey}">
                                    ${indicator.options.map(option => {
                                        const [value, text] = option.split(': ');
                                        return `<option value="${value}">${text}</option>`;
                                    }).join('')}
                                </select>
                            `;
                            criterionDiv.appendChild(formGroup);
                        }
                    }
                }
            }
        }
    });

    $('#selfAssessmentForm').on('submit', function(e) {
        e.preventDefault();

        var formData = {};
        $(this).serializeArray().forEach(function(item) {
            formData[item.name] = item.value;
        });

        frappe.call({
            method: 'accreditation_management.www.self_assessment.submit_self_assessment',
            args: {
                form_data: JSON.stringify(formData)
            },
            freeze: true,
            callback: function(r) {
                if (!r.exc) {
                    frappe.msgprint({
                        title: __('Form Submitted'),
                        indicator: 'green',
                        message: __('Your self-assessment form has been submitted successfully.')
                    });
                } else {
                    frappe.msgprint({
                        title: __('Submission Failed'),
                        indicator: 'red',
                        message: __('There was an error submitting your form. Please try again.')
                    });
                }
            }
        });
    });
});
</script>
{% endblock %}
