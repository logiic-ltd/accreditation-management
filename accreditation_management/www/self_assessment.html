{% extends "templates/web.html" %}

{% block page_content %}
<div class="container mt-5">
    <h1 class="mb-4">School Self-Assessment</h1>
    
    <div id="school-search">
        <h2>Find Your School</h2>
        <p>Search for your school by name or school code.</p>
        <div class="input-group mb-3">
            <input type="text" id="school-search-input" class="form-control" placeholder="Enter school name or code">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="search-button">Search</button>
            </div>
        </div>
    </div>

    <div id="school-results" style="display: none;">
        <h3>Search Results</h3>
        <ul id="school-list" class="list-group">
            <!-- School results will be populated here -->
        </ul>
    </div>

    <div id="selected-school" style="display: none;">
        <h3>Selected School</h3>
        <div id="selected-school-info"></div>
        <button id="start-assessment-button" class="btn btn-primary mt-3">Start Self-Assessment</button>
    </div>
</div>

<script>
frappe.ready(function() {
    let selectedSchool = null;

    $('#search-button').click(function() {
        const searchTerm = $('#school-search-input').val();
        if (searchTerm) {
            searchSchools(searchTerm);
        }
    });

    function searchSchools(term) {
        frappe.call({
            method: 'accreditation_management.www.self_assessment.search_schools',
            args: { search_term: term },
            callback: function(r) {
                if (r.message) {
                    displaySchoolResults(r.message);
                }
            }
        });
    }

    function displaySchoolResults(schools) {
        const schoolList = $('#school-list');
        schoolList.empty();
        schools.forEach(function(school) {
            const li = $('<li class="list-group-item"></li>');
            li.html(`<strong>${school.name}</strong> (Code: ${school.code})<br>${school.address}`);
            li.click(function() {
                selectedSchool = school;
                displaySelectedSchool(school);
            });
            schoolList.append(li);
        });
        $('#school-results').show();
        $('#selected-school').hide();
    }

    function displaySelectedSchool(school) {
        const schoolInfo = $('#selected-school-info');
        schoolInfo.html(`
            <p><strong>School Name:</strong> ${school.name}</p>
            <p><strong>School Code:</strong> ${school.code}</p>
            <p><strong>Address:</strong> ${school.address}</p>
            <p><strong>Owner:</strong> ${school.owner}</p>
        `);
        $('#school-results').hide();
        $('#selected-school').show();
    }

    $('#start-assessment-button').click(function() {
        if (selectedSchool) {
            startSelfAssessment(selectedSchool);
        }
    });

    function startSelfAssessment(school) {
        frappe.call({
            method: 'accreditation_management.www.self_assessment.start_self_assessment',
            args: { school: school },
            callback: function(r) {
                if (r.message) {
                    window.location.href = r.message;
                }
            }
        });
    }
});
</script>
{% endblock %}
