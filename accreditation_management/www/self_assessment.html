{% extends "templates/web.html" %}

{% block page_content %}
<div class="container mt-5">
    <h1 class="mb-4">School Self-Assessment</h1>
    
    <div id="school-search">
        <h2>Find Your School</h2>
        <p>Search for your school by name or school code.</p>
        <div class="input-group mb-3">
            <input type="text" id="school-search-input" class="form-control" placeholder="Enter school name or code">
        </div>
    </div>

    <div id="school-results" style="display: none;">
        <h3>Search Results</h3>
        <div id="school-list">
            <!-- School results will be populated here -->
        </div>
    </div>

    <div id="selected-school" style="display: none;">
        <h3>Selected School</h3>
        <div id="selected-school-info"></div>
        <button id="start-assessment-button" class="btn btn-primary mt-3">Start Self-Assessment</button>
    </div>
</div>

<script>
frappe.ready(function() {
    let selectedSchool = null;

    function init_school_search() {
        let $search_input = $('#school-search-input');
        let $results = $('#school-results');
        let searchTimeout;

        $search_input.on('input', function() {
            clearTimeout(searchTimeout);
            let search_term = $search_input.val();
            if (search_term.length < 2) {
                $results.empty().hide();
                return;
            }
            $results.html('<p>Searching...</p>').show();
            searchTimeout = setTimeout(() => {
                frappe.call({
                    method: 'accreditation_management.www.self_assessment.search_schools',
                    type: 'GET',
                    args: { 
                        search_term: search_term,
                        page: 0,
                        size: 20,
                        sort: 'schoolName,asc'
                    },
                    callback: function(r) {
                        console.log("API Response:", r);
                        if (r.message && r.message.content && r.message.content.length > 0) {
                            let results = r.message.content;
                            let html = results.map(item => `
                                <div class="school-item" style="cursor: pointer; padding: 5px; border-bottom: 1px solid #ccc;">
                                    <strong>${frappe.utils.escape_html(item.schoolName)}</strong>
                                    <br>
                                    <small>${frappe.utils.escape_html(item.province + ', ' + item.district)}</small>
                                </div>
                            `).join('');
                            $results.html(html).show();
                            $results.find('.school-item').on('click', function() {
                                let index = $(this).index();
                                let item = results[index];
                                selectedSchool = {
                                    id: item.id || item.schoolCode,
                                    name: item.schoolName,
                                    code: item.schoolCode,
                                    address: item.province + ', ' + item.district,
                                    owner: item.schoolOwner
                                };
                                displaySelectedSchool(selectedSchool);
                            });
                        } else {
                            $results.html('<p>No results found or unable to connect to the API. Please try again later.</p>').show();
                        }
                    }
                });
            }, 300);
        });

        $search_input.on('input', function() {
            if ($search_input.val() === '') {
                $results.empty().hide();
            }
        });
    }

    function displaySelectedSchool(school) {
        const schoolInfo = $('#selected-school-info');
        schoolInfo.html(`
            <p><strong>School Name:</strong> ${frappe.utils.escape_html(school.name)}</p>
            <p><strong>School Code:</strong> ${frappe.utils.escape_html(school.code)}</p>
            <p><strong>Address:</strong> ${frappe.utils.escape_html(school.address)}</p>
            <p><strong>Owner:</strong> ${frappe.utils.escape_html(school.owner)}</p>
        `);
        $('#school-results').hide();
        $('#selected-school').show();
    }

    $('#start-assessment-button').click(function() {
        if (selectedSchool) {
            startSelfAssessment(selectedSchool);
        }
    });

    function startSelfAssessment(school) {
        frappe.call({
            method: 'accreditation_management.www.self_assessment.start_self_assessment',
            args: { school: school },
            callback: function(r) {
                if (r.message) {
                    window.location.href = r.message;
                }
            }
        });
    }

    init_school_search();
});
</script>
{% endblock %}
