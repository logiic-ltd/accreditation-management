{% extends "templates/web.html" %}

{% block page_content %}
<div class="content-wrapper">
    <div class="container">
        <h1 class="mb-4">Self Assessment Form</h1>
        <form id="selfAssessmentForm">
            <div class="form-group">
                <label for="schoolName">School Name</label>
                <input type="text" class="form-control" id="schoolName" name="school_name" required>
            </div>
            <div class="form-group">
                <label for="submissionDate">Submission Date</label>
                <input type="date" class="form-control" id="submissionDate" name="submission_date" required>
            </div>
            <div id="indicators"></div>
            <div id="provisionalResults" class="mt-4">
                <h3>Provisional Results</h3>
                <p id="overallScore">Overall Score: 0%</p>
                <p id="provisionalRanking">Provisional Ranking: N/A</p>
                <p id="provisionalDecision">Provisional Decision: N/A</p>
                <p id="provisionalYears">Provisional Accreditation Years: N/A</p>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Submit</button>
        </form>
    </div>
</div>

<script>
frappe.ready(function() {
    // Load the indicator options from the JSON configuration file
    frappe.call({
        method: 'accreditation_management.www.self_assessment.get_indicator_options',
        callback: function(r) {
            if (r.message) {
                const indicators = r.message;
                const indicatorsContainer = document.getElementById('indicators');
                for (const [area, criteria] of Object.entries(indicators)) {
                    const areaDiv = document.createElement('div');
                    areaDiv.innerHTML = `<h3>${area}</h3>`;
                    indicatorsContainer.appendChild(areaDiv);
                    for (const [criterion, indicatorData] of Object.entries(criteria)) {
                        const criterionDiv = document.createElement('div');
                        criterionDiv.innerHTML = `<h4>${criterion}</h4>`;
                        areaDiv.appendChild(criterionDiv);
                        for (const [indicatorKey, indicator] of Object.entries(indicatorData)) {
                            const formGroup = document.createElement('div');
                            formGroup.className = 'form-group';
                            formGroup.innerHTML = `
                                <label for="${indicatorKey}">${indicator.label}</label>
                                <select class="form-control" id="${indicatorKey}" name="${indicatorKey}">
                                    ${indicator.options.map(option => {
                                        const [value, text] = option.split(': ');
                                        return `<option value="${value}">${text}</option>`;
                                    }).join('')}
                                </select>
                            `;
                            formGroup.querySelector('select').addEventListener('change', calculateProvisionalResults);
                            criterionDiv.appendChild(formGroup);
                        }
                    }
                }
            }
        }
    });

    function calculateProvisionalResults() {
        const formData = new FormData(document.getElementById('selfAssessmentForm'));
        const areaScores = {};
        let overallScore = 0;

        // Calculate scores for each area
        for (const [area, criteria] of Object.entries(indicators)) {
            let areaTotal = 0;
            let criteriaCount = 0;
            for (const criterion of Object.keys(criteria)) {
                let criterionTotal = 0;
                let indicatorCount = 0;
                for (const indicatorKey of Object.keys(criteria[criterion])) {
                    const value = parseInt(formData.get(indicatorKey)) || 0;
                    criterionTotal += value;
                    indicatorCount++;
                }
                const criterionScore = (criterionTotal / (indicatorCount * 4)) * 100;
                areaTotal += criterionScore;
                criteriaCount++;
            }
            const areaScore = (areaTotal / criteriaCount) * (parseFloat(area.split('%')[0]) / 100);
            areaScores[area] = areaScore;
            overallScore += areaScore;
        }

        // Update provisional results
        document.getElementById('overallScore').textContent = `Overall Score: ${overallScore.toFixed(2)}%`;
        document.getElementById('provisionalRanking').textContent = `Provisional Ranking: ${getProvisionalRanking(overallScore)}`;
        document.getElementById('provisionalDecision').textContent = `Provisional Decision: ${getProvisionalDecision(overallScore)}`;
        document.getElementById('provisionalYears').textContent = `Provisional Accreditation Years: ${getProvisionalYears(overallScore)}`;
    }

    function getProvisionalRanking(score) {
        if (score >= 80) return "Outstanding";
        if (score >= 70) return "Good";
        if (score >= 50) return "Satisfactory";
        return "Unsatisfactory";
    }

    function getProvisionalDecision(score) {
        if (score >= 80) return "Accreditation Granted";
        if (score >= 70) return "Accreditation Granted";
        if (score >= 50) return "Accreditation Granted";
        return "Accreditation Not Granted";
    }

    function getProvisionalYears(score) {
        if (score >= 80) return 3;
        if (score >= 70) return 2;
        if (score >= 50) return 1;
        return 0;
    }

    $('#selfAssessmentForm').on('submit', function(e) {
        e.preventDefault();

        var formData = {};
        $(this).serializeArray().forEach(function(item) {
            formData[item.name] = item.value;
        });

        frappe.call({
            method: 'accreditation_management.www.self_assessment.submit_self_assessment',
            args: {
                form_data: JSON.stringify(formData)
            },
            freeze: true,
            callback: function(r) {
                if (!r.exc) {
                    frappe.msgprint({
                        title: __('Form Submitted'),
                        indicator: 'green',
                        message: __('Your self-assessment form has been submitted successfully.')
                    });
                } else {
                    frappe.msgprint({
                        title: __('Submission Failed'),
                        indicator: 'red',
                        message: __('There was an error submitting your form. Please try again.')
                    });
                }
            }
        });
    });
});
</script>
{% endblock %}
