{% extends "templates/web.html" %}

{% block style %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;600;700&display=swap');

    :root {
        --primary-color: #078ece;
        --secondary-color: #054d6f;
        --accent-color: #24a148;
        --text-color: #161616;
        --light-bg: #eee;
    }

    table td:last-child div {
        display: flex;
        align-items: center;
    }

    table td:last-child label {
        margin-left: 5px;
    }

    table td:last-child {
        background-color: #ffffff;
    }

    table td:first-child {
        background-color: #eee;
    }

    table {
        width: 90%;
    }

    table th:first-child,
    table td:first-child {
        width: 40%;
        vertical-align: middle;
    }

    table th:last-child,
    table td:last-child {
        width: 60%;
    }

    table thead th {
        background-color: #078ece;
        color: #ffffff;
        font-weight: bold;
    }

    html, body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        width: 100%;
        font-family: 'IBM Plex Sans', sans-serif;
        color: var(--text-color);
        background-color: #ffffff;
    }

    .content-wrapper {
        padding: 2rem 0;
        width: 90vw;
        margin-left: -45vw;
        left: 50%;
        position: relative;
    }

    .container {
        width: 90%;
        max-width: 90%;
        padding: 0;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        border-radius: 0.25rem;
        border: 1px solid #ccc;
        padding: 0.5rem;
        width: 100%;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: #ffffff;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: #ffffff;
    }

    #provisionalResults {
        background-color: #ffffff;
        padding: 1rem;
        border-radius: 0.25rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    #indicators h3, #indicators h4 {
        color: var(--secondary-color);
    }

    .indicator-score {
        font-size: 0.9rem;
        color: var(--accent-color);
    }
</style>
{% endblock %}

{% block page_content %}
<div class="content-wrapper">
    <div class="container">
        <h1 class="mb-4">Self Assessment Form</h1>
        <form id="selfAssessmentForm">
            <div class="form-section" id="section1">
                <div class="form-group">
                    <label for="schoolName">School Name</label>
                    <input type="text" class="form-control" id="schoolName" name="school_name" required>
                </div>
                <div class="form-group">
                    <label for="submissionDate">Submission Date</label>
                    <input type="date" class="form-control" id="submissionDate" name="submission_date" required>
                </div>
            </div>
            <div class="form-section" id="section2" style="display:none;">
                <h3>A. Land ownership, legal, School leadership and management documents</h3>
                <div id="indicators-area-a"></div>
            </div>
            <div class="form-section" id="section3" style="display:none;">
                <h3>School Infrastructures</h3>
                <div id="indicators-area-b"></div>
            </div>
            <div class="form-section" id="section4" style="display:none;">
                <h3>Teaching and Learning Resources</h3>
                <div id="indicators-area-c"></div>
            </div>
            <div class="form-section" id="section5" style="display:none;">
                <div id="provisionalResults" class="mt-4">
                    <h3>Provisional Results</h3>
                    <p id="overallScore">Overall Score: 0%</p>
                    <p id="provisionalRanking">Provisional Ranking: N/A</p>
                    <p id="provisionalDecision">Provisional Decision: N/A</p>
                    <p id="provisionalYears">Provisional Accreditation Years: N/A</p>
                </div>
            </div>
            <div class="navigation-buttons mt-3">
                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="nextPrev(-1)">Previous</button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextPrev(1)">Next</button>
                <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">Submit</button>
            </div>
        </form>
    </div>
</div>
<script>                                                                                                                                      
    let currentSection = 0;
    const sections = document.querySelectorAll('.form-section');

    function showSection(n) {
        sections[n].style.display = 'block';
        document.getElementById('prevBtn').style.display = n === 0 ? 'none' : 'inline';
        document.getElementById('nextBtn').style.display = n === (sections.length - 1) ? 'none' : 'inline';
        document.getElementById('submitBtn').style.display = n === (sections.length - 1) ? 'inline' : 'none';
    }

    function nextPrev(n) {
        sections[currentSection].style.display = 'none';
        currentSection += n;
        if (currentSection >= sections.length) {
            document.getElementById('selfAssessmentForm').submit();
            return false;
        }
        showSection(currentSection);
    }

    frappe.ready(function() {
        showSection(currentSection);

        // Load the indicator options from the JSON configuration file
        frappe.call({
            method: 'accreditation_management.www.self_assessment.get_indicator_options',
            callback: function(r) {
                if (r.message) {
                    const indicators = r.message;
                    const indicatorsAreaA = document.getElementById('indicators-area-a');
                    const indicatorsAreaB = document.getElementById('indicators-area-b');
                    const indicatorsAreaC = document.getElementById('indicators-area-c');

                    for (const [area, criteria] of Object.entries(indicators)) {
                        let areaDiv;
                        if (area.includes("A. Land ownership")) {
                            areaDiv = indicatorsAreaA;
                        } else if (area.includes("School Infrastructures")) {
                            areaDiv = indicatorsAreaB;
                        } else if (area.includes("Teaching and learning Resources")) {
                            areaDiv = indicatorsAreaC;
                        } else {
                            continue;
                        }
                        for (const [criterion, indicatorData] of Object.entries(criteria)) {
                            const table = document.createElement('table');
                            table.className = 'table table-bordered';
                            table.innerHTML = `<thead><tr><th>${criterion}</th><th>Options</th></tr></thead>`;
                            const tbody = document.createElement('tbody');
                            table.appendChild(tbody);
                            areaDiv.appendChild(table);

                            for (const [indicatorKey, indicator] of Object.entries(indicatorData)) {
                                const row = document.createElement('tr');
                                const indicatorCell = document.createElement('td');
                                indicatorCell.textContent = indicator.label;
                                const optionsCell = document.createElement('td');

                                indicator.options.forEach(option => {
                                    const [value, text] = option.split(': ');
                                    const radio = document.createElement('input');
                                    radio.type = 'radio';
                                    radio.name = indicatorKey;
                                    radio.value = value;
                                    radio.addEventListener('change', calculateProvisionalResults);

                                    const label = document.createElement('label');
                                    label.textContent = text;
                                    label.style.marginRight = '10px';

                                    const optionContainer = document.createElement('div');
                                    optionContainer.appendChild(radio);
                                    optionContainer.appendChild(label);
                                    optionsCell.appendChild(optionContainer);
                                });

                                row.appendChild(indicatorCell);
                                row.appendChild(optionsCell);
                                tbody.appendChild(row);
                            }
                        }
                    }
                }
            }
        });

        function calculateProvisionalResults() {
            const formData = new FormData(document.getElementById('selfAssessmentForm'));
            const areaScores = {};
            let overallScore = 0;

            // Calculate scores for each area
            for (const [area, criteria] of Object.entries(indicators)) {
                let areaTotal = 0;
                let criteriaCount = 0;
                for (const criterion of Object.keys(criteria)) {
                    let criterionTotal = 0;
                    let indicatorCount = 0;
                    for (const indicatorKey of Object.keys(criteria[criterion])) {
                        const value = parseInt(formData.get(indicatorKey)) || 0;
                        criterionTotal += value;
                        indicatorCount++;
                    }
                    const criterionScore = (criterionTotal / (indicatorCount * 4)) * 100;
                    areaTotal += criterionScore;
                    criteriaCount++;
                }
                const areaWeight = parseFloat(area.match(/(\d+)%/)[1]) / 100;
                const areaScore = (areaTotal / criteriaCount) * areaWeight;
                areaScores[area] = areaScore;
                overallScore += areaScore;
            }

            // Update provisional results
            document.getElementById('overallScore').textContent = `Overall Score: ${overallScore.toFixed(2)}%`;
            document.getElementById('provisionalRanking').textContent = `Provisional Ranking: ${getProvisionalRanking(overallScore)}`;
            document.getElementById('provisionalDecision').textContent = `Provisional Decision: ${getProvisionalDecision(overallScore)}`;
            document.getElementById('provisionalYears').textContent = `Provisional Accreditation Years: ${getProvisionalYears(overallScore)}`;
        }

        // Ensure provisional results are calculated on page load
        calculateProvisionalResults();

        function getProvisionalRanking(score) {
            if (score >= 80) return "Outstanding";
            if (score >= 70) return "Good";
            if (score >= 50) return "Satisfactory";
            return "Unsatisfactory";
        }

        function getProvisionalDecision(score) {
            if (score >= 80) return "Accreditation Granted";
            if (score >= 70) return "Accreditation Granted";
            if (score >= 50) return "Accreditation Granted";
            return "Accreditation Not Granted";
        }

        function getProvisionalYears(score) {
            if (score >= 80) return 3;
            if (score >= 70) return 2;
            if (score >= 50) return 1;
            return 0;
        }

        $('#selfAssessmentForm').on('submit', function(e) {
            e.preventDefault();

            var formData = {};
            $(this).serializeArray().forEach(function(item) {
                formData[item.name] = item.value;
            });

            frappe.call({
                method: 'accreditation_management.www.self_assessment.submit_self_assessment',
                args: {
                    form_data: JSON.stringify(formData)
                },
                freeze: true,
                callback: function(r) {
                    if (!r.exc) {
                        frappe.msgprint({
                            title: __('Form Submitted'),
                            indicator: 'green',
                            message: __('Your self-assessment form has been submitted successfully.')
                        });
                    } else {
                        frappe.msgprint({
                            title: __('Submission Failed'),
                            indicator: 'red',
                            message: __('There was an error submitting your form. Please try again.')
                        });
                    }
                }
            });
        });
    });
    </script> 
{% endblock %}
