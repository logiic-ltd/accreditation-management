{% extends "templates/web.html" %}

{% block style %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;600;700&display=swap');

    :root {
        --primary-color: #078ece;
        --secondary-color: #054d6f;
        --accent-color: #24a148;
        --text-color: #161616;
        --light-bg: #eee;
    }

    /* Verification Modal Styles */
    .verification-container {
        position: relative;
        padding: 2rem;
    }

    .icon-circle {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }

    .verification-title {
        color: var(--secondary-color);
        font-weight: 600;
        font-size: 1.5rem;
    }

    .email-display {
        color: var(--primary-color);
        font-weight: 600;
        font-size: 1.1rem;
    }

    .code-inputs {
        gap: 8px;
    }

    .code-input {
        width: 45px;
        height: 55px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 24px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .code-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(7, 142, 206, 0.2);
        outline: none;
    }

    .code-input.error {
        border-color: #dc3545;
        animation: shake 0.5s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .btn-verify {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 1rem;
        border-radius: 8px;
        font-weight: 600;
        position: relative;
        overflow: hidden;
    }

    .verification-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100% { transform: rotate(360deg); }
    }

    .btn-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .btn-link:hover {
        text-decoration: none;
        opacity: 0.8;
    }

    .verification-feedback .alert {
        border-radius: 8px;
        padding: 1rem;
    }

    .verification-feedback .alert.alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .verification-feedback .alert.alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .form-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        padding: 1.5rem 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-header h1 {
        color: white;
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .progress-container {
        flex: 0 0 200px;
        margin-left: 2rem;
    }

    .progress {
        height: 8px;
        background-color: rgba(255,255,255,0.2);
        border-radius: 4px;
        overflow: hidden;
        margin: 0;
    }

    .progress-bar {
        background-color: white;
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease-in-out;
    }

    html, body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        width: 100%;
        font-family: 'IBM Plex Sans', sans-serif;
        color: var(--text-color);
        background-color: var(--light-bg);
    }

    .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .form-section {
        padding: 4rem 0;
        background-color: #ffffff;
        width: 100vw;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        position: relative;
    }

    .form-title {
        text-align: center;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 2rem;
        color: var(--secondary-color);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        border-radius: 4px;
        border: 1px solid #ccc;
        padding: 0.5rem;
        width: 100%;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: #ffffff;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: #ffffff;
    }

    fieldset {
        border: 1px solid #ddd;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 4px;
        display: none;
    }

    fieldset.active {
        display: block;
    }

    legend {
        font-weight: 600;
        color: var(--secondary-color);
        padding: 0 0.5rem;
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }

    .form-navigation button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-prev {
        background-color: #6c757d;
        border-color: #6c757d;
        color: #ffffff;
    }

    .btn-next {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: #ffffff;
    }


    .summary-container {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .summary-section {
        margin-bottom: 2rem;
        padding: 1rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .summary-section h4 {
        color: var(--secondary-color);
        margin-bottom: 1rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
    }

    .summary-label {
        font-weight: 600;
        color: #495057;
    }

    .summary-value {
        color: #212529;
    }

    .field-error {
        border-color: #dc3545 !important;
        background-color: #fff8f8;
    }

    .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block page_content %}
<section class="form-section">
    <div class="container">
        <div class="form-header">
            <h1>School Identification Form</h1>
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
        <form id="schoolIdentificationForm">
            <fieldset>
                <legend>School Search</legend>
                <div class="form-group">
                    <label for="schoolSearch">Search School</label>
                    <input type="text" class="form-control" id="schoolSearch" placeholder="Start typing to search...">
                    <div id="schoolSearchResults" class="mt-2"></div>
                </div>
                <div id="schoolInfoTable" style="display: none;">
                    <div class="alert alert-info mb-3">
                        Please verify your access to this school's email before proceeding.
                    </div>
                    <table class="table table-bordered">
                        <tbody>
                            <tr><th>School Name</th><td id="schoolNameDisplay"></td></tr>
                            <tr><th>School Code</th><td id="schoolCodeDisplay"></td></tr>
                            <tr><th>School Email</th><td id="schoolEmailDisplay"></td></tr>
                            <tr><th>Province</th><td id="provinceDisplay"></td></tr>
                            <tr><th>District</th><td id="districtDisplay"></td></tr>
                            <tr><th>Sector</th><td id="sectorDisplay"></td></tr>
                            <tr><th>Cell</th><td id="cellDisplay"></td></tr>
                            <tr><th>Village</th><td id="villageDisplay"></td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Verification Modal -->
                <div class="modal fade" id="verificationModal" tabindex="-1" role="dialog" aria-labelledby="verificationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 15px 35px rgba(0,0,0,0.15);">
                            <div class="modal-body p-0">
                                <div class="verification-container p-4">
                                    <button type="button" class="close position-absolute" data-dismiss="modal" aria-label="Close" style="right: 1.5rem; top: 1.5rem;">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    
                                    <div class="text-center mb-4">
                                        <div class="verification-icon mb-4">
                                            <div class="icon-circle">
                                                <i class="fa fa-envelope-open-text fa-2x text-white"></i>
                                            </div>
                                        </div>
                                        <h4 class="verification-title mb-3">Verify Your Email</h4>
                                        <p class="text-muted mb-2">We've sent a verification code to:</p>
                                        <p class="email-display mb-4" id="verificationEmailDisplay"></p>
                                    </div>

                                    <div class="verification-code-container mb-4">
                                        <div class="code-inputs d-flex justify-content-center gap-2">
                                            <input type="text" class="code-input" maxlength="1" data-index="0">
                                            <input type="text" class="code-input" maxlength="1" data-index="1">
                                            <input type="text" class="code-input" maxlength="1" data-index="2">
                                            <input type="text" class="code-input" maxlength="1" data-index="3">
                                            <input type="text" class="code-input" maxlength="1" data-index="4">
                                            <input type="text" class="code-input" maxlength="1" data-index="5">
                                        </div>
                                        <input type="hidden" id="verificationCode">
                                    </div>

                                    <div class="verification-actions">
                                        <button type="button" class="btn btn-verify w-100 mb-3" id="verifyCodeBtn">
                                            <span class="verify-text">Verify Code</span>
                                            <div class="verification-loader" style="display: none;">
                                                <div class="spinner"></div>
                                            </div>
                                        </button>
                                        
                                        <div class="text-center">
                                            <span class="text-muted">Didn't receive the code?</span>
                                            <button type="button" class="btn btn-link p-0 ml-1" id="resendCodeBtn">
                                                Resend Code
                                                <span class="resend-timer ml-1" style="display: none"></span>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="verification-feedback mt-3" style="display: none;">
                                        <div class="alert d-flex align-items-center" role="alert">
                                            <i class="fa mr-2"></i>
                                            <span class="feedback-message"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Basic School Information</legend>
                <div class="form-group">
                    <label for="schoolName">School Name</label>
                    <input type="text" class="form-control" id="schoolName" name="school_name" required>
                </div>
                <div class="form-group">
                    <label for="schoolCode">School Code</label>
                    <input type="text" class="form-control" id="schoolCode" name="school_code">
                </div>
                <div class="form-group">
                    <label for="schoolEmail">School Email</label>
                    <input type="email" class="form-control" id="schoolEmail" name="school_email">
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select class="form-control" id="status" name="status" required>
                        <option value="" disabled selected>Select Status</option>
                        <option value="Public">Public</option>
                        <option value="Private">Private</option>
                        <option value="Government Aided">Government Aided</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="typeOfSchool">Type of School</label>
                    <select class="form-control" id="typeOfSchool" name="type_of_school" required>
                        <option value="" disabled selected>Select Type</option>
                        <option value="TVET">TVET (TSS OR VTC)</option>
                        <option value="General Education">General Education</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="schoolOwner">School Owner</label>
                    <input type="text" class="form-control" id="schoolOwner" name="school_owner">
                </div>
                <div class="form-group">
                    <label for="contact">Contact</label>
                    <input type="text" class="form-control" id="contact" name="contact">
                </div>
                <div class="form-group">
                    <label for="accommodationStatus">Accommodation Status</label>
                    <select class="form-control" id="accommodationStatus" name="accommodation_status" required>
                        <option value="" disabled selected>Select Status</option>
                        <option value="Day">Day</option>
                        <option value="Boarding">Boarding</option>
                        <option value="Mixed">Mixed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="yearOfEstablishment">Year of Establishment</label>
                    <input type="number" class="form-control" id="yearOfEstablishment" name="year_of_establishment">
                </div>
            </fieldset>

            <fieldset>
                <legend>Location Details</legend>
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <td>Village</td>
                            <td><input type="text" class="form-control" id="village" name="village"></td>
                        </tr>
                        <tr>
                            <td>Cell</td>
                            <td><input type="text" class="form-control" id="cell" name="cell"></td>
                        </tr>
                        <tr>
                            <td>Sector</td>
                            <td><input type="text" class="form-control" id="sector" name="sector"></td>
                        </tr>
                        <tr>
                            <td>District</td>
                            <td><input type="text" class="form-control" id="district" name="district"></td>
                        </tr>
                        <tr>
                            <td>Province</td>
                            <td><input type="text" class="form-control" id="province" name="province"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="form-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" step="0.00000001" class="form-control" id="latitude" name="latitude" placeholder="e.g. -1.9441">
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" step="0.00000001" class="form-control" id="longitude" name="longitude" placeholder="e.g. 30.0619">
                </div>
            </fieldset>

            <fieldset>
                <legend>Head Teacher Information</legend>
                <div class="form-group">
                    <label for="htName">HT/Name</label>
                    <input type="text" class="form-control" id="htName" name="ht_name">
                </div>
                <div class="form-group">
                    <label for="qualificationOfHeadteacher">Qualification of Head Teacher</label>
                    <input type="text" class="form-control" id="qualificationOfHeadteacher" name="qualification_of_headteacher">
                </div>
                <div class="form-group">
                    <label for="telephone">Telephone</label>
                    <input type="tel" class="form-control" id="telephone" name="telephone">
                </div>
            </fieldset>

            <fieldset>
                <legend>Student Information</legend>
                <div class="form-group">
                    <label for="numberOfBoys">Number of Boys</label>
                    <input type="text" class="form-control" id="numberOfBoys" name="number_of_boys">
                </div>
                <div class="form-group">
                    <label for="numberOfGirls">Number of Girls</label>
                    <input type="text" class="form-control" id="numberOfGirls" name="number_of_girls">
                </div>
                <div class="form-group">
                    <label for="totalNrStudents">Total Nr. Students in the School</label>
                    <input type="text" class="form-control" id="totalNrStudents" name="total_nr_students" readonly>
                </div>
                <div class="form-group">
                    <label for="studentsWithSEN">Students with SEN</label>
                    <input type="text" class="form-control" id="studentsWithSEN" name="students_with_sen">
                </div>
            </fieldset>

            <fieldset>
                <legend>Teaching Staff</legend>
                <div class="form-group">
                    <label for="numberOfMaleTeachers">Number of Male Teachers</label>
                    <input type="number" class="form-control" id="numberOfMaleTeachers" name="number_of_male_teachers">
                </div>
                <div class="form-group">
                    <label for="numberOfFemaleTeachers">Number of Female Teachers</label>
                    <input type="number" class="form-control" id="numberOfFemaleTeachers" name="number_of_female_teachers">
                </div>
                <div class="form-group">
                    <label for="numberOfTeachers">Total Number of Teachers</label>
                    <input type="number" class="form-control" id="numberOfTeachers" name="number_of_teachers" readonly>
                </div>
                <div class="form-group">
                    <label for="numberOfMaleAssistantTeachers">Number of Male Assistant Teachers</label>
                    <input type="number" class="form-control" id="numberOfMaleAssistantTeachers" name="number_of_male_assistant_teachers">
                </div>
                <div class="form-group">
                    <label for="numberOfFemaleAssistantTeachers">Number of Female Assistant Teachers</label>
                    <input type="number" class="form-control" id="numberOfFemaleAssistantTeachers" name="number_of_female_assistant_teachers">
                </div>
                <div class="form-group">
                    <label for="numberOfAssistantTeachers">Total Number of Assistant Teachers</label>
                    <input type="number" class="form-control" id="numberOfAssistantTeachers" name="number_of_assistant_teachers" readonly>
                </div>
            </fieldset>

            <fieldset>
                <legend>Administrative Staff</legend>
                <div class="form-group">
                    <label for="headteacher">Headteacher</label>
                    <input type="text" class="form-control" id="headteacher" name="headteacher">
                </div>
                <div class="form-group">
                    <label for="deputyHeadteacher">Deputy Headteacher</label>
                    <input type="text" class="form-control" id="deputyHeadteacher" name="deputy_headteacher">
                </div>
                <div class="form-group">
                    <label for="secretary">Secretary</label>
                    <input type="text" class="form-control" id="secretary" name="secretary">
                </div>
                <div class="form-group">
                    <label for="librarian">Librarian</label>
                    <input type="text" class="form-control" id="librarian" name="librarian">
                </div>
                <div class="form-group">
                    <label for="accountant">Accountant</label>
                    <input type="text" class="form-control" id="accountant" name="accountant">
                </div>
                <div class="form-group">
                    <label for="otherStaff">Other Staff (Specify)</label>
                    <input type="text" class="form-control" id="otherStaff" name="other_staff">
                </div>
                <div class="form-group">
                    <label for="totalNumberOfAdministrativeStaff">Total Number of Administrative Staff</label>
                    <input type="text" class="form-control" id="totalNumberOfAdministrativeStaff" name="total_number_of_administrative_staff" readonly>
                </div>
            </fieldset>

            <fieldset>
                <legend>Supporting Staff</legend>
                <div class="form-group">
                    <label for="cleaners">Cleaners</label>
                    <input type="text" class="form-control" id="cleaners" name="cleaners">
                </div>
                <div class="form-group">
                    <label for="watchmen">Watchmen</label>
                    <input type="text" class="form-control" id="watchmen" name="watchmen">
                </div>
                <div class="form-group">
                    <label for="schoolCooks">School Cooks</label>
                    <input type="text" class="form-control" id="schoolCooks" name="school_cooks">
                </div>
                <div class="form-group">
                    <label for="storekeeper">Storekeeper</label>
                    <input type="text" class="form-control" id="storekeeper" name="storekeeper">
                </div>
                <div class="form-group">
                    <label for="drivers">Drivers</label>
                    <input type="text" class="form-control" id="drivers" name="drivers">
                </div>
                <div class="form-group">
                    <label for="otherSupportingStaff">Other Supporting Staff (Specify)</label>
                    <input type="text" class="form-control" id="otherSupportingStaff" name="other_supporting_staff">
                </div>
                <div class="form-group">
                    <label for="totalNumberOfSupportingStaff">Total Number of Supporting Staff</label>
                    <input type="text" class="form-control" id="totalNumberOfSupportingStaff" name="total_number_of_supporting_staff" readonly>
                </div>
            </fieldset>

            <fieldset>
                <legend>Infrastructure</legend>
                <div class="form-group">
                    <label for="nbrOfClassrooms">Nbr. of All Classrooms at the School</label>
                    <input type="text" class="form-control" id="nbrOfClassrooms" name="nbr_of_classrooms">
                </div>
                <div class="form-group">
                    <label for="nbrOfLatrines">Nr. of All Latrines/Toilets</label>
                    <input type="text" class="form-control" id="nbrOfLatrines" name="nbr_of_latrines">
                </div>
                <div class="form-group">
                    <label for="numberOfKitchen">Number of Kitchen</label>
                    <input type="text" class="form-control" id="numberOfKitchen" name="number_of_kitchen">
                </div>
                <div class="form-group">
                    <label for="numberOfDiningHall">Number of Dining Hall</label>
                    <input type="text" class="form-control" id="numberOfDiningHall" name="number_of_dining_hall">
                </div>
                <div class="form-group">
                    <label for="numberOfLibrary">Number of Library</label>
                    <input type="text" class="form-control" id="numberOfLibrary" name="number_of_library">
                </div>
                <div class="form-group">
                    <label for="numberOfSmartClassrooms">Number of Smart Classrooms</label>
                    <input type="text" class="form-control" id="numberOfSmartClassrooms" name="number_of_smart_classrooms">
                </div>
                <div class="form-group">
                    <label for="numberOfComputerLab">Number of Computer Laboratory</label>
                    <input type="text" class="form-control" id="numberOfComputerLab" name="number_of_computer_lab">
                </div>
                <div class="form-group">
                    <label for="numberOfAdminOffices">Number of Administrative Staff Offices</label>
                    <input type="text" class="form-control" id="numberOfAdminOffices" name="number_of_admin_offices">
                </div>
                <div class="form-group">
                    <label for="numberOfMultipurposeHalls">Number of Multipurpose Halls</label>
                    <input type="text" class="form-control" id="numberOfMultipurposeHalls" name="number_of_multipurpose_halls">
                </div>
                <div class="form-group">
                    <label for="numberOfAcademicStaffRooms">Number of Academic Staff Rooms</label>
                    <input type="text" class="form-control" id="numberOfAcademicStaffRooms" name="number_of_academic_staff_rooms">
                </div>
            </fieldset>

            <fieldset>
                <legend>Summary</legend>
                <div class="summary-container">
                    <h4>Basic Information</h4>
                    <div id="basicInfoSummary" class="summary-section"></div>
                    
                    <h4>Student Information</h4>
                    <div id="studentInfoSummary" class="summary-section"></div>
                    
                    <h4>Staff Information</h4>
                    <div id="staffInfoSummary" class="summary-section"></div>
                    
                    <h4>Infrastructure</h4>
                    <div id="infrastructureSummary" class="summary-section"></div>
                </div>
            </fieldset>

            <div class="form-navigation">
                <button type="button" class="btn btn-prev" id="prevButton" style="display: none;">Previous</button>
                <button type="button" class="btn btn-next" id="nextButton">Next</button>
            </div>
        </form>
    </div>
</section>

<script>
frappe.ready(function() {
    // Check if coming from accreditation page
    const requestType = localStorage.getItem('accreditationRequestType');
    if (requestType) {
        frappe.show_alert({
            message: `Starting application process for ${requestType}`,
            indicator: 'blue'
        }, 5);
    }
    
    initSchoolSearch();
    initFormNavigation();

    let emailVerified = false;
    
    function initFormNavigation() {
        const sections = $('fieldset');
        let currentSection = 0;
        
        function updateNextButton() {
            if (currentSection === 0) {
                if ($('#schoolInfoTable').is(':visible')) {
                    if (emailVerified) {
                        $('#nextButton').text('Next').prop('disabled', false);
                    } else {
                        $('#nextButton').text('Verify School Email').prop('disabled', false);
                    }
                } else {
                    $('#nextButton').text('Next').prop('disabled', true);
                }
            } else {
                $('#nextButton').text(currentSection === sections.length - 1 ? 'Continue to Self Assessment' : 'Next');
            }
        }
        
        // Show first section by default
        $(sections[0]).addClass('active');
        
        // Update progress bar
        function updateProgress() {
            const progress = ((currentSection + 1) / sections.length) * 100;
            $('.progress-bar').css('width', progress + '%');
        }
        
        // Handle next button click
        $('#nextButton').click(function() {
            if (currentSection === 0 && !emailVerified && $('#schoolInfoTable').is(':visible')) {
                // Show verification modal and send code
                const schoolEmail = $('#schoolEmailDisplay').text();
                if (schoolEmail === 'N/A' || !schoolEmail) {
                    frappe.msgprint({
                        title: __('Error'),
                        indicator: 'red',
                        message: __('No email address available for this school.')
                    });
                    return;
                }
                
                // Update email display in modal
                $('#verificationEmailDisplay').text(schoolEmail);
                
                // Clear previous code and errors
                $('#verificationCode').val('');
                $('#verificationSuccess').hide();
                
                // Show modal
                $('#verificationModal').modal('show');
                
                // Focus on input
                setTimeout(() => {
                    $('#verificationCode').focus();
                }, 500);
                
                frappe.call({
                    method: 'accreditation_management.www.school_identification.send_verification_code',
                    args: {
                        school_email: schoolEmail
                    },
                    callback: function(r) {
                        if (!r.exc) {
                            frappe.show_alert({
                                message: __('Verification code sent to school email'),
                                indicator: 'blue'
                            }, 5);
                        }
                    }
                });
                return;
            }
            
            if (currentSection === sections.length - 1) {
                // On the last section, submit the form
                $('#schoolIdentificationForm').submit();
            } else if (currentSection < sections.length - 1) {
                $(sections[currentSection]).removeClass('active');
                currentSection++;
                $(sections[currentSection]).addClass('active');
                
                // Show/hide navigation buttons
                $('#prevButton').show();
                if (currentSection === sections.length - 1) {
                    $('#nextButton').text('Continue to Self Assessment');
                    $('#nextButton').addClass('btn-primary');
                    populateSummary();
                } else {
                    $('#nextButton').text('Next');
                    $('#nextButton').removeClass('btn-primary');
                }
                
                updateProgress();
                window.scrollTo(0, 0);
            }
        });
        
        // Handle previous button click
        $('#prevButton').click(function() {
            if (currentSection > 0) {
                $(sections[currentSection]).removeClass('active');
                currentSection--;
                $(sections[currentSection]).addClass('active');
                
                // Show/hide navigation buttons
                $('#nextButton').show().text('Next').removeClass('btn-primary');
                if (currentSection === 0) {
                    $('#prevButton').hide();
                }
                
                updateProgress();
                window.scrollTo(0, 0);
            }
        });
        
        // Initialize progress bar
        updateProgress();
    }

    function calculateTotalAdministrativeStaff() {
        const fields = ['headteacher', 'deputyHeadteacher', 'secretary', 'librarian', 'accountant', 'otherStaff'];
        let total = 0;
        fields.forEach(field => {
            const value = parseInt($(`#${field}`).val()) || 0;
            total += value;
        });
        $('#totalNumberOfAdministrativeStaff').val(total);
    }

    function calculateTotalSupportingStaff() {
        const fields = ['cleaners', 'watchmen', 'schoolCooks', 'storekeeper', 'drivers', 'otherSupportingStaff'];
        let total = 0;
        fields.forEach(field => {
            const value = parseInt($(`#${field}`).val()) || 0;
            total += value;
        });
        $('#totalNumberOfSupportingStaff').val(total);
    }

    function calculateTotalStudents() {
        const boys = parseInt($('#numberOfBoys').val()) || 0;
        const girls = parseInt($('#numberOfGirls').val()) || 0;
        $('#totalNrStudents').val(boys + girls);
    }

    function calculateTotalTeachers() {
        const maleTeachers = parseInt($('#numberOfMaleTeachers').val()) || 0;
        const femaleTeachers = parseInt($('#numberOfFemaleTeachers').val()) || 0;
        $('#numberOfTeachers').val(maleTeachers + femaleTeachers);
    }

    function calculateTotalAssistantTeachers() {
        const maleAssistantTeachers = parseInt($('#numberOfMaleAssistantTeachers').val()) || 0;
        const femaleAssistantTeachers = parseInt($('#numberOfFemaleAssistantTeachers').val()) || 0;
        $('#numberOfAssistantTeachers').val(maleAssistantTeachers + femaleAssistantTeachers);
    }

    $('#schoolIdentificationForm input').on('input', function() {
        calculateTotalAdministrativeStaff();
        calculateTotalSupportingStaff();
        calculateTotalStudents();
        calculateTotalTeachers();
        calculateTotalAssistantTeachers();
    });
    
    // Initialize verification code inputs
    function initVerificationInputs() {
        const inputs = document.querySelectorAll('.code-input');
        
        inputs.forEach((input, index) => {
            input.addEventListener('keyup', (e) => {
                const value = e.target.value;
                
                // Only allow numbers
                if (!/^\d*$/.test(value)) {
                    input.value = '';
                    return;
                }
                
                // Auto-focus next input
                if (value && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
                
                // Handle backspace
                if (e.key === 'Backspace' && !value && index > 0) {
                    inputs[index - 1].focus();
                }
                
                // Update hidden input with complete code
                updateVerificationCode();
            });
            
            // Handle paste event
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
                
                pastedData.split('').forEach((digit, i) => {
                    if (inputs[i]) {
                        inputs[i].value = digit;
                    }
                });
                
                updateVerificationCode();
                if (inputs[pastedData.length]) {
                    inputs[pastedData.length].focus();
                }
            });
        });
    }
    
    function updateVerificationCode() {
        const code = Array.from(document.querySelectorAll('.code-input'))
            .map(input => input.value)
            .join('');
        document.getElementById('verificationCode').value = code;
    }
    
    // Handle verification code submission
    $('#verifyCodeBtn').click(function() {
        const $btn = $(this);
        const $loader = $btn.find('.verification-loader');
        const $text = $btn.find('.verify-text');
        const schoolEmail = $('#schoolEmailDisplay').text();
        const code = $('#verificationCode').val();
        
        if (code.length !== 6) {
            showVerificationFeedback('error', 'Please enter the complete 6-digit code');
            $('.code-input').addClass('error');
            setTimeout(() => $('.code-input').removeClass('error'), 500);
            return;
        }
        
        // Show loading state
        $btn.prop('disabled', true);
        $text.css('opacity', '0');
        $loader.show();
        
        frappe.call({
            method: 'accreditation_management.www.school_identification.verify_code',
            args: {
                school_email: schoolEmail,
                verification_code: code
            },
            callback: function(r) {
                if (!r.exc) {
                    emailVerified = true;
                    showVerificationFeedback('success', 'Email verified successfully!');
                    
                    setTimeout(() => {
                        $('#verificationModal').modal('hide');
                        const sections = $('fieldset');
                        $(sections[0]).removeClass('active');
                        $(sections[1]).addClass('active');
                        $('#prevButton').show();
                        updateProgress();
                        window.scrollTo(0, 0);
                    }, 1500);
                } else {
                    const errorMsg = r._server_messages ? JSON.parse(r._server_messages)[0] : 'Verification failed';
                    showVerificationFeedback('error', errorMsg);
                    resetVerificationForm();
                    // Reset button state
                    $btn.prop('disabled', false);
                    $text.css('opacity', '1');
                    $loader.hide();
                }
            },
            error: function() {
                showVerificationFeedback('error', 'Network error. Please try again.');
                resetVerificationForm();
                // Reset button state
                $btn.prop('disabled', false);
                $text.css('opacity', '1');
                $loader.hide();
            }
        });
    });
    
    function showVerificationFeedback(type, message) {
        const $feedback = $('.verification-feedback');
        const $alert = $feedback.find('.alert');
        const $icon = $feedback.find('.fa');
        const $message = $feedback.find('.feedback-message');
        
        $alert.removeClass('alert-success alert-danger')
              .addClass(type === 'success' ? 'alert-success' : 'alert-danger');
        $icon.removeClass('fa-check-circle fa-exclamation-circle')
             .addClass(type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle');
        $message.text(message);
        $feedback.fadeIn();
    }
    
    function resetVerificationForm() {
        const $btn = $('#verifyCodeBtn');
        const $loader = $btn.find('.verification-loader');
        const $text = $btn.find('.verify-text');
        
        $btn.prop('disabled', false);
        $text.css('opacity', '1');
        $loader.hide();
        $('.code-input').val('').first().focus();
        $('#verificationCode').val('');
    }
    
    // Handle resend code with cooldown
    let resendTimer = null;
    $('#resendCodeBtn').click(function() {
        const $btn = $(this);
        const $timer = $btn.find('.resend-timer');
        
        if ($btn.prop('disabled')) return;
        
        const schoolEmail = $('#schoolEmailDisplay').text();
        $btn.prop('disabled', true);
        
        frappe.call({
            method: 'accreditation_management.www.school_identification.send_verification_code',
            args: { school_email: schoolEmail },
            callback: function(r) {
                if (!r.exc) {
                    showVerificationFeedback('success', 'New verification code sent');
                    startResendTimer($btn, $timer);
                } else {
                    $btn.prop('disabled', false);
                    showVerificationFeedback('error', 'Failed to send code. Please try again.');
                }
            }
        });
    });
    
    function startResendTimer($btn, $timer) {
        let timeLeft = 30;
        $timer.show();
        
        if (resendTimer) clearInterval(resendTimer);
        
        resendTimer = setInterval(() => {
            timeLeft--;
            $timer.text(`(${timeLeft}s)`);
            
            if (timeLeft <= 0) {
                clearInterval(resendTimer);
                $btn.prop('disabled', false);
                $timer.hide();
            }
        }, 1000);
    }
    
    // Initialize verification inputs when modal shows
    $('#verificationModal').on('shown.bs.modal', function() {
        initVerificationInputs();
        $('.code-input').first().focus();
    });

    function populateSummary() {
        // Basic Information Summary
        const basicInfo = {
            'School Name': $('#schoolName').val(),
            'School Code': $('#schoolCode').val(),
            'Status': $('#status').val(),
            'Type of School': $('#typeOfSchool').val(),
            'School Owner': $('#schoolOwner').val()
        };
        
        // Student Information Summary
        const studentInfo = {
            'Total Students': $('#totalNrStudents').val(),
            'Boys': $('#numberOfBoys').val(),
            'Girls': $('#numberOfGirls').val(),
            'Students with SEN': $('#studentsWithSEN').val()
        };
        
        // Staff Information Summary
        const staffInfo = {
            'Total Teachers': $('#numberOfTeachers').val(),
            'Total Assistant Teachers': $('#numberOfAssistantTeachers').val(),
            'Administrative Staff': $('#totalNumberOfAdministrativeStaff').val(),
            'Supporting Staff': $('#totalNumberOfSupportingStaff').val()
        };
        
        // Infrastructure Summary
        const infrastructureInfo = {
            'Classrooms': $('#nbrOfClassrooms').val(),
            'Latrines/Toilets': $('#nbrOfLatrines').val(),
            'Kitchen': $('#numberOfKitchen').val(),
            'Dining Hall': $('#numberOfDiningHall').val(),
            'Library': $('#numberOfLibrary').val(),
            'Smart Classrooms': $('#numberOfSmartClassrooms').val(),
            'Computer Laboratory': $('#numberOfComputerLab').val(),
            'Administrative Offices': $('#numberOfAdminOffices').val(),
            'Multipurpose Halls': $('#numberOfMultipurposeHalls').val(),
            'Academic Staff Rooms': $('#numberOfAcademicStaffRooms').val()
        };

        // Populate summary sections
        ['basicInfo', 'studentInfo', 'staffInfo', 'infrastructureInfo'].forEach(section => {
            const $container = $(`#${section}Summary`);
            $container.empty();
            
            const data = eval(section);
            Object.entries(data).forEach(([label, value]) => {
                if (value) {
                    $container.append(`
                        <div class="summary-item">
                            <span class="summary-label">${label}:</span>
                            <span class="summary-value">${value}</span>
                        </div>
                    `);
                }
            });
        });
    }

    function clearValidationErrors() {
        $('.field-error').removeClass('field-error');
        $('.error-message').remove();
    }

    function handleValidationErrors(errors) {
        clearValidationErrors();
        
        Object.entries(errors).forEach(([fieldName, errorMessage]) => {
            const field = $(`[name="${fieldName}"]`);
            if (field.length) {
                field.addClass('field-error');
                field.after(`<div class="error-message">${errorMessage}</div>`);
                
                // If this field is in a non-active section, switch to that section
                const fieldset = field.closest('fieldset');
                if (!fieldset.hasClass('active')) {
                    const sections = $('fieldset');
                    const currentSection = sections.index(fieldset);
                    
                    // Update navigation
                    sections.removeClass('active');
                    fieldset.addClass('active');
                    
                    // Update buttons and progress
                    $('#prevButton').toggle(currentSection > 0);
                    $('#nextButton').text(currentSection === sections.length - 1 ? 'Continue to Self Assessment' : 'Next');
                    
                    // Update progress bar
                    const progress = ((currentSection + 1) / sections.length) * 100;
                    $('.progress-bar').css('width', progress + '%');
                    
                    window.scrollTo(0, 0);
                }
            }
        });
        
        // Scroll to first error if not visible
        const firstError = $('.field-error').first();
        if (firstError.length) {
            const errorTop = firstError.offset().top - 100;
            window.scrollTo(0, errorTop);
        }
    }

    $('#schoolIdentificationForm').on('submit', function(e) {
        e.preventDefault();
        clearValidationErrors();

        var formData = {};
        $(this).serializeArray().forEach(function(item) {
            formData[item.name] = item.value;
        });

        frappe.call({
            method: 'accreditation_management.www.school_identification.submit_school_identification',
            args: {
                form_data: JSON.stringify(formData)
            },
            freeze: true,
            callback: function(r) {
                if (!r.exc) {
                    frappe.msgprint({
                        title: __('Form Submitted'),
                        indicator: 'green',
                        message: __('Your school identification form has been submitted successfully.')
                    });
                    // Store school details and request type in localStorage before redirecting
                    const schoolDetails = {
                        schoolName: $('#schoolName').val(),
                        schoolCode: $('#schoolCode').val(),
                        province: $('#province').val(),
                        district: $('#district').val(),
                        sector: $('#sector').val(),
                        cell: $('#cell').val(),
                        village: $('#village').val(),
                        requestType: localStorage.getItem('accreditationRequestType')
                    };
                    localStorage.setItem('schoolDetails', JSON.stringify(schoolDetails));
                    window.location.href = '/self_assessment';
                } else {
                    if (r._server_messages) {
                        try {
                            const errors = JSON.parse(r._server_messages);
                            if (typeof errors === 'object' && errors !== null) {
                                handleValidationErrors(errors);
                                frappe.msgprint({
                                    title: __('Validation Failed'),
                                    indicator: 'red',
                                    message: __('Please correct the highlighted fields and try again.')
                                });
                                return;
                            }
                        } catch (e) {
                            // If not validation errors, show generic error
                        }
                    }
                    frappe.msgprint({
                        title: __('Submission Failed'),
                        indicator: 'red',
                        message: __('There was an error submitting your form. Please try again.')
                    });
                }
            }
        });
    });
});

function initSchoolSearch() {
    let $searchInput = $('#schoolSearch');
    let $results = $('#schoolSearchResults');
    let searchTimeout;

    $searchInput.on('input', function() {
        clearTimeout(searchTimeout);
        let searchTerm = $searchInput.val();
        if (searchTerm.length < 3) {
            $results.empty();
            return;
        }

        $results.html('<p>Searching...</p>');

        searchTimeout = setTimeout(() => {
            frappe.call({
                method: 'accreditation_management.www.self_assessment.search_schools',
                args: { search_term: searchTerm },
                callback: function(r) {
                    if (r.message && r.message.content && r.message.content.length > 0) {
                        let results = r.message.content;
                        let html = results.map(item => `
                            <div class="school-item" style="cursor: pointer; padding: 5px; border-bottom: 1px solid #ccc;">
                                <strong>${frappe.utils.escape_html(item.schoolName)}</strong><br>
                                <small>${frappe.utils.escape_html(item.province || '')}${item.province && item.district ? ', ' : ''}${frappe.utils.escape_html(item.district || '')}</small>
                            </div>
                        `).join('');
                        $results.html(html);

                        $results.find('.school-item').on('click', function() {
                            let index = $(this).index();
                            let item = results[index];
                            $('#schoolName').val(item.schoolName);
                            $('#schoolCode').val(item.schoolCode);
                            $('#schoolEmail').val(item.schoolEmail || '');  // Set email field
                            $('#schoolNameDisplay').text(item.schoolName);
                            $('#schoolCodeDisplay').text(item.schoolCode);
                            $('#schoolEmailDisplay').text(item.schoolEmail || 'N/A');
                            $('#provinceDisplay').text(item.province || 'N/A');
                            $('#districtDisplay').text(item.district || 'N/A');
                            $('#sectorDisplay').text(item.sector || 'N/A');
                            $('#cellDisplay').text(item.cell || 'N/A');
                            $('#villageDisplay').text(item.village || 'N/A');
                            $('#schoolInfoTable').show();
                            $searchInput.val(item.schoolName);
                            $results.empty();

                            // Populate other form fields
                            $('#schoolEmail').val(item.schoolEmail || '');  // Ensure email is populated
                            $('#status').val(item.status || '');
                            $('#schoolOwner').val(item.schoolOwner || '');
                            $('#contact').val(item.contact || '');
                            $('#accommodationStatus').val(item.accommodationStatus || '');
                            $('#yearOfEstablishment').val(item.yearOfEstablishment || '');
                            $('#village').val(item.village || '');
                            $('#cell').val(item.cell || '');
                            $('#sector').val(item.sector || '');
                            $('#district').val(item.district || '');
                            $('#province').val(item.province || '');
                        });
                    } else {
                        $results.html('<p>No results found or unable to connect to the API. Please try again later.</p>');
                    }
                }
            });
        }, 300);
    });

    $searchInput.on('blur', function() {
        setTimeout(() => {
            $results.empty();
        }, 200);
    });
}
</script>
{% endblock %}
